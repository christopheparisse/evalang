---
title: "DCPLX - Manuel version R"
author: "Christophe Parisse"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## The data

The data is collected from CSV files that are the ouput of the TextToKids chain.

The only metadata information from the TextToKids chain is in the filename So this filemame has to be decomposed to get metadata information. The name of the filename is generated by the TEICORPO commands when preparing the file to be used by the TextToKids chain.

Names have the form: chi_Auguste_5.83{GS}.txt where the filename is composed of user category + user name + user age + user ses. Information about the name of the corpus are provided in the R commands.

The data is processed and a table is generated with the first 10 colummns which are metadata and the rest of the columns that are the output from the TextToKids chain (9 for texts, 11 for sentences).

-   corpus
-   filename
-   part
-   name
-   age
-   serial
-   eco
-   id_text
-   document
-   sent_id (only for sentences)
-   sentence (only for sentences)

For each piece of data, it is possible to build a 90% subset for training and a 10% subset for testing.

## The processing

### find_the_processors_and_models

Calcule pour un ensemble de textes quels sont les processeurs qui sont les mieux corrélés avec l'âge des enfants produisant les textes.

Crée un tableau ('bestcor') dans lequel pour tous les processeurs calculés pour chaque texte on trouve les valeurs moyennes, ecarts types, quantiles et corrélation avec l'âge (et proba des corrélations). Copie toutes les données dans le modèle (dans 'data')

Le tableau est trié par la valeur des corrélations et permet de connaitre les meilleurs processeurs.

Ensuite pour tous les 'n' meilleurs processeurs filtrés par la proba donnée en paramètre de la fonction, on fait les traitements suivants:

-   adjp: récupération du mean et du sd pour les processeurs intéressants. (les 'n' processeurs qui ont une corrélation d'au moins la proba)
-   info: calcul de toutes les valeurs normalisées (autour de M = 1 et SD = 1) pour tous les processeurs intéressants et tous les textes. Permet d'avoir des notes équivalentes pour tous les 'n' meilleurs processeurs. Un calcul de corrélation globale confirme les valeurs (à comparer avec les corrélations de processeurs eux-mêmes)
-   model: calcul des modèles de régression pour tous les processeurs en fonction de l'âge. Utilise la régression linéaire pour calculer les approximations linéaires pour l'age pour chacun des processeurs.
-   allnotes: calcul de toutes les notes en fonction des model (projection de l'âge en fonction de la note de base et du modèle)

### test_the_processors_and_models

Fait une évaluation globale des prédictions d'âge. Le calcul produit plusieurs représentations graphiques et résultats: - boxplot des notes calculées dans allnotes - une table des relations entre moyennes des notes et age - plot entre moyennes et ages - la corrélation entre moyennes et ages

### Continuer la description et tester avec des parties de test

Test fait en comparant l'identification des 10% de textes de test avec l'auto test sur l'ensemble de références.

```{r}
colaje_text_all_2_mdl <- find_the_processors_and_models(colaje_text_all_2$data, .6, "COLAJE.6")
colaje_nts <- test_the_processors_and_models(colaje_text_all_2$test, colaje_text_all_2_mdl, "COLAJE TEST")
colaje_nts <- test_the_processors_and_models(colaje_text_all_2$data, colaje_text_all_2_mdl, "COLAJE TEST wiht DATA itself")
```

##### Including Plots

```{r echo=FALSE}
plot(as.numeric(colaje_nts$ages), colaje_nts$mean, main="COLAJE .6")
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

### Générer des notes pour des énoncés

Le calcul des notes est basé sur les quantiles des résultats de la chaine de traitement de TextToKids.
Un fichier CSV (csvref) sert de référence pour les calculs de quantiles.
Un fichier CSV (csvtest) sert à lister les énoncés à mesurer et les valeurs qu'ils ont pour les processeurs de TextToKids.

On part d'abord de la liste brute des processeurs: processor_list_sent

On calcule ensuite toutes les corrélations de ces processeurs (pour les énoncés) avec l'âge: allcor(). Le résultat est trié par rapport aux corrélations. Les âges sont arrondis à l'année près.

On utilise la fonction bestprocsent pour s'informer sur les processeurs au dessus d'un certain quantile.

On utilise get_phr_eval(csvref, csvorderref, csvtest, numphr, n, seuil) pour connaitre les scores pour l'énoncé numphr de csvtest. 'n' est le nombre de processeurs à considérer. Seuil est la valeur au delà de laquelle un quantile est considéré comme intéressant 

La fonction display_best_sent_texte appelle la fonction précédente pour tous les énoncés d'un texte de test (csvtext) et exporte le résultat dans un fichier CSV.

```{r}
print('sur sent_tv avec référence sent_tv')
display_best_sent_texte(sent_tv, allcortv_order, sent_tv, "chi_Alban_5.11{GS}.txt", 10, .6, 8, "chi_Alban_5.11.csv", "v")
print('sur sent_tv avec référence colaje_sentence')
display_best_sent_texte(colaje_sentence, allcorsent_order, sent_tv, "chi_Alban_5.11{GS}.txt", 20, .9, 12, "chi_Alban_5.11.csv", "v")
```
